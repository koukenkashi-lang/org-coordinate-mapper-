<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>çµ„ç¹”åº§æ¨™ãƒãƒƒãƒ”ãƒ³ã‚°</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: #0f1117;
    color: #e4e4e7;
    min-height: 100vh;
    padding: 24px;
  }

  .container { max-width: 960px; margin: 0 auto; }

  h1 {
    font-size: 22px;
    font-weight: 700;
    color: #f4f4f5;
    margin-bottom: 4px;
    letter-spacing: 0.02em;
  }

  .subtitle {
    font-size: 13px;
    color: #71717a;
    margin-bottom: 24px;
  }

  .tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .tab-btn {
    padding: 8px 20px;
    font-size: 13px;
    font-family: inherit;
    font-weight: 400;
    background: transparent;
    color: #71717a;
    border: 1px solid transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .tab-btn.active {
    font-weight: 600;
    background: #1e1e2e;
    color: #f4f4f5;
    border-color: #2e2e3e;
  }

  .content-row {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
  }

  .panel {
    background: #16171f;
    border-radius: 12px;
    border: 1px solid #2e2e3e;
    padding: 20px;
  }

  .panel-plot { flex: 1 1 420px; padding: 16px; }
  .panel-form { flex: 1 1 280px; }
  .panel-full { flex: 1 1 100%; }

  .panel h3 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #f4f4f5;
  }

  label {
    display: block;
    font-size: 11px;
    color: #a1a1aa;
    margin-bottom: 4px;
    font-weight: 500;
  }

  input[type="text"] {
    width: 100%;
    padding: 8px 10px;
    font-size: 13px;
    font-family: inherit;
    background: #1e1e2e;
    border: 1px solid #2e2e3e;
    border-radius: 6px;
    color: #f4f4f5;
    outline: none;
  }

  input[type="range"] {
    width: 100%;
    accent-color: #6366f1;
  }

  .range-labels {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: #52525b;
  }

  .field { margin-bottom: 12px; }
  .field-slider { margin-bottom: 14px; }

  .btn-primary {
    width: 100%;
    padding: 10px;
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    background: #6366f1;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-primary:hover { background: #5558e6; }

  .btn-secondary {
    flex: 1;
    padding: 8px;
    font-size: 12px;
    font-family: inherit;
    background: #1e1e2e;
    color: #a1a1aa;
    border: 1px solid #2e2e3e;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-secondary:hover { background: #252535; }

  .btn-excel {
    flex: 1;
    padding: 8px;
    font-size: 12px;
    font-family: inherit;
    background: #1e3a2e;
    color: #4ade80;
    border: 1px solid #2e5e3e;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-excel:hover { background: #254a38; }

  .btn-row {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #2e2e3e;
  }

  .btn-row-excel {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }

  .excel-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #2e2e3e;
  }

  .excel-section h4 {
    font-size: 12px;
    font-weight: 600;
    color: #4ade80;
    margin-bottom: 10px;
  }

  .excel-hint {
    font-size: 10px;
    color: #52525b;
    margin-top: 6px;
    line-height: 1.5;
  }

  .import-result {
    margin-top: 8px;
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 11px;
    display: none;
  }

  .import-result.success {
    display: block;
    background: rgba(74, 222, 128, 0.1);
    border: 1px solid rgba(74, 222, 128, 0.3);
    color: #4ade80;
  }

  .import-result.error {
    display: block;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #fca5a5;
  }

  .member-tags {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #2e2e3e;
  }

  .member-tags p {
    font-size: 11px;
    color: #71717a;
    margin-bottom: 8px;
  }

  .tag-list { display: flex; flex-wrap: wrap; gap: 4px; }

  .tag {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    border: 1px solid;
    transition: all 0.15s;
  }

  .plot-legend {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
    flex-wrap: wrap;
  }

  .plot-legend span { font-size: 10px; color: #71717a; }
  .plot-legend .gold { color: #fbbf24; }

  .health-card { flex: 1 1 280px; text-align: center; padding: 24px; }
  .health-label { font-size: 12px; color: #71717a; margin-bottom: 8px; }
  .health-score { font-size: 56px; font-weight: 700; line-height: 1; }
  .health-max { font-size: 11px; color: #52525b; margin-top: 8px; }

  .warning-box {
    margin-top: 16px;
    padding: 10px 14px;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    font-size: 12px;
    color: #fca5a5;
    text-align: left;
  }

  .logic-section { margin-top: 20px; text-align: left; }
  .logic-section p.logic-title { font-size: 11px; color: #71717a; margin-bottom: 6px; }
  .logic-section p.logic-body { font-size: 10px; color: #52525b; line-height: 1.6; }

  .dist-card { flex: 1 1 380px; padding: 24px; }
  .dist-title { font-size: 13px; font-weight: 600; color: #f4f4f5; margin-bottom: 16px; }

  .bar-item { margin-bottom: 14px; }
  .bar-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
  .bar-name { font-size: 12px; font-weight: 500; }
  .bar-name .count { color: #52525b; font-weight: 400; }
  .bar-value { font-size: 12px; color: #a1a1aa; }

  .bar-track { height: 8px; background: #1e1e2e; border-radius: 4px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease; }

  .center-box {
    margin-top: 20px;
    padding: 12px 14px;
    background: #1e1e2e;
    border-radius: 8px;
    font-size: 12px;
    color: #a1a1aa;
    line-height: 1.7;
  }

  .center-box strong { font-weight: 600; color: #f4f4f5; }
  .center-box .note { font-size: 11px; color: #71717a; }

  .reading-card { padding: 24px; }
  .reading-title { font-size: 13px; font-weight: 600; color: #f4f4f5; margin-bottom: 12px; }
  .reading-body { font-size: 12px; color: #a1a1aa; line-height: 1.8; }
  .reading-body p { margin-bottom: 8px; }
  .reading-body .hl-gold { color: #fbbf24; font-weight: 600; }
  .reading-body .hl-red { color: #ef4444; font-weight: 600; }

  .empty-state { padding: 40px; text-align: center; color: #52525b; font-size: 13px; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }

  th {
    padding: 10px 14px;
    text-align: left;
    font-size: 11px;
    color: #71717a;
    font-weight: 500;
    border-bottom: 1px solid #2e2e3e;
  }

  td { padding: 10px 14px; border-bottom: 1px solid #1e1e2e; }
  td.name-cell { font-weight: 500; color: #f4f4f5; }

  .q-badge { font-size: 11px; padding: 2px 8px; border-radius: 4px; }

  .remove-btn {
    background: transparent;
    border: none;
    color: #52525b;
    cursor: pointer;
    font-size: 13px;
    font-family: inherit;
  }

  .remove-btn:hover { color: #ef4444; }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  input[type="file"] { display: none; }

  @media (max-width: 640px) {
    body { padding: 16px; }
    h1 { font-size: 18px; }
    .content-row { gap: 16px; }
    .panel-plot, .panel-form { flex: 1 1 100%; }
  }
</style>
</head>
<body>

<div class="container">
  <h1>çµ„ç¹”åº§æ¨™ãƒãƒƒãƒ”ãƒ³ã‚°</h1>
  <p class="subtitle">Xè»¸ï¼šä¿å®ˆâ‡”é©æ–°ã€€Yè»¸ï¼šåˆ©å·±â‡”å…¬å…±ã€€Zè»¸ï¼ˆå††ã®å¤§ãã•ï¼‰ï¼šæ¨©åŠ›</p>

  <div class="tabs">
    <button class="tab-btn active" data-tab="map">åº§æ¨™ãƒãƒƒãƒ—</button>
    <button class="tab-btn" data-tab="analysis">çµ„ç¹”åˆ†æ</button>
    <button class="tab-btn" data-tab="members">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</button>
  </div>

  <div id="tab-map" class="tab-content active">
    <div class="content-row">
      <div class="panel panel-plot">
        <svg id="plot" viewBox="0 0 400 400" style="width:100%;max-width:400px"></svg>
        <div class="plot-legend">
          <span>å††ã®å¤§ãã•ï¼æ¨©åŠ›ï¼ˆZè»¸ï¼‰</span>
          <span class="gold">ï¼‹ çµ„ç¹”ã®é‡å¿ƒï¼ˆæ¨©åŠ›åŠ é‡ï¼‰</span>
        </div>
      </div>
      <div class="panel panel-form">
        <h3>ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </h3>
        <div class="field">
          <label>åå‰ãƒ»å½¹è·</label>
          <input type="text" id="input-name" placeholder="ä¾‹ï¼šéƒ¨é•·A">
        </div>
        <div class="field-slider">
          <label>Xè»¸ï¼šä¿å®ˆæ€§ï¼š<span id="val-x">5</span></label>
          <input type="range" id="input-x" min="0" max="10" value="5">
          <div class="range-labels"><span>é©æ–° (0)</span><span>ä¿å®ˆ (10)</span></div>
        </div>
        <div class="field-slider">
          <label>Yè»¸ï¼šå…¬å…±æ€§ï¼š<span id="val-y">5</span></label>
          <input type="range" id="input-y" min="0" max="10" value="5">
          <div class="range-labels"><span>åˆ©å·± (0)</span><span>å…¬å…± (10)</span></div>
        </div>
        <div class="field-slider">
          <label>Zè»¸ï¼šæ¨©åŠ›ï¼š<span id="val-z">5</span></label>
          <input type="range" id="input-z" min="1" max="10" value="5">
          <div class="range-labels"><span>ä½ (1)</span><span>é«˜ (10)</span></div>
        </div>
        <button class="btn-primary" id="btn-add">è¿½åŠ </button>

        <div class="btn-row">
          <button class="btn-secondary" id="btn-sample">ã‚µãƒ³ãƒ—ãƒ«èª­è¾¼</button>
          <button class="btn-secondary" id="btn-clear">å…¨å‰Šé™¤</button>
        </div>

        <!-- Excel section -->
        <div class="excel-section">
          <h4>ğŸ“Š Excelé€£æº</h4>
          <div class="btn-row-excel">
            <button class="btn-excel" id="btn-import">Excelèª­è¾¼</button>
            <button class="btn-excel" id="btn-export">Excelå‡ºåŠ›</button>
            <button class="btn-excel" id="btn-template">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
          </div>
          <input type="file" id="file-input" accept=".xlsx,.xls,.csv">
          <p class="excel-hint">åˆ—ã®ä¸¦ã³ï¼šåå‰ / Xï¼ˆä¿å®ˆæ€§ï¼‰/ Yï¼ˆå…¬å…±æ€§ï¼‰/ Zï¼ˆæ¨©åŠ›ï¼‰<br>1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™</p>
          <div class="import-result" id="import-result"></div>
        </div>

        <div class="member-tags" id="tag-area"></div>
      </div>
    </div>
  </div>

  <div id="tab-analysis" class="tab-content">
    <div id="analysis-content"></div>
  </div>

  <div id="tab-members" class="tab-content">
    <div class="panel" id="members-content" style="padding:0;overflow:hidden;"></div>
  </div>
</div>

<script>
const SAMPLE = [
  { id: 1, name: "ä¸Šå¸Aï¼ˆéƒ¨é•·ï¼‰", x: 7, y: 2, z: 8 },
  { id: 2, name: "åŒåƒšBï¼ˆä¸€èˆ¬ï¼‰", x: 7, y: 3, z: 2 },
  { id: 3, name: "å…ˆè¼©Cï¼ˆèª²é•·ï¼‰", x: 4, y: 7, z: 6 },
  { id: 4, name: "è‹¥æ‰‹Dï¼ˆä¸»ä»»ï¼‰", x: 2, y: 8, z: 3 },
  { id: 5, name: "å½¹å“¡E", x: 8, y: 2, z: 10 },
  { id: 6, name: "ä¸­å …Fï¼ˆä¿‚é•·ï¼‰", x: 5, y: 5, z: 4 },
];

const QC = {
  topLeft:     { bg: "rgba(59,130,246,0.08)",  border: "#3b82f6", label: "é©æ–°Ã—å…¬å…±", desc: "å¤‰é©ã®æ¨é€²è€…" },
  topRight:    { bg: "rgba(16,185,129,0.08)",  border: "#10b981", label: "ä¿å®ˆÃ—å…¬å…±", desc: "çµ„ç¹”ã®å®ˆè­·è€…" },
  bottomLeft:  { bg: "rgba(245,158,11,0.08)",  border: "#f59e0b", label: "é©æ–°Ã—åˆ©å·±", desc: "é‡å¿ƒçš„ç ´å£Šè€…" },
  bottomRight: { bg: "rgba(239,68,68,0.08)",   border: "#ef4444", label: "ä¿å®ˆÃ—åˆ©å·±", desc: "é™ã‹ãªã‚‹å²©" },
};

let members = [];
let nextId = 1;
let selectedId = null;

function getQ(x, y) {
  if (x <= 5 && y > 5) return "topLeft";
  if (x > 5 && y > 5) return "topRight";
  if (x <= 5 && y <= 5) return "bottomLeft";
  return "bottomRight";
}

function dotColor(x, y) { return QC[getQ(x, y)].border; }

const PAD = 40, SIZE = 400;
function px(v) { return PAD + (v / 10) * (SIZE - PAD * 2); }
function py(v) { return PAD + ((10 - v) / 10) * (SIZE - PAD * 2); }

function svgEl(tag, attrs, parent) {
  const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
  for (const [k, v] of Object.entries(attrs || {})) el.setAttribute(k, v);
  if (parent) parent.appendChild(el);
  return el;
}

function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

function analyze() {
  if (!members.length) return null;
  const quads = { topLeft: [], topRight: [], bottomLeft: [], bottomRight: [] };
  let totalZ = 0, wX = 0, wY = 0;
  members.forEach(m => {
    quads[getQ(m.x, m.y)].push(m);
    totalZ += m.z; wX += m.x * m.z; wY += m.y * m.z;
  });
  const cx = totalZ ? wX / totalZ : 5;
  const cy = totalZ ? wY / totalZ : 5;
  const qPow = {};
  for (const q of Object.keys(quads)) qPow[q] = quads[q].reduce((s, m) => s + m.z, 0);
  const brRatio = totalZ ? qPow.bottomRight / totalZ : 0;
  const pwY = totalZ ? wY / totalZ : 5;
  const health = Math.round(Math.max(0, Math.min(100, (pwY / 10) * 60 + (1 - brRatio) * 40)));
  return { quads, qPow, cx, cy, totalZ, health, pwY, brRatio, critical: brRatio > 0.5 };
}

function renderPlot() {
  const svg = document.getElementById("plot");
  svg.innerHTML = "";
  const half = (SIZE - PAD * 2) / 2;

  const qPos = [
    ["topLeft", px(0), py(10)], ["topRight", px(5), py(10)],
    ["bottomLeft", px(0), py(5)], ["bottomRight", px(5), py(5)]
  ];
  qPos.forEach(([q, x, y]) => svgEl("rect", { x, y, width: half, height: half, fill: QC[q].bg }, svg));

  const qlPos = [
    ["topLeft", 2.5, 8], ["topRight", 7.5, 8],
    ["bottomLeft", 2.5, 2.5], ["bottomRight", 7.5, 2.5]
  ];
  qlPos.forEach(([q, cx, cy]) => {
    svgEl("text", { x: px(cx), y: py(cy), "text-anchor": "middle", fill: QC[q].border, "font-size": "9", "font-weight": "600", opacity: "0.7" }, svg).textContent = QC[q].label;
    svgEl("text", { x: px(cx), y: py(cy) + 13, "text-anchor": "middle", fill: QC[q].border, "font-size": "7", opacity: "0.5" }, svg).textContent = QC[q].desc;
  });

  svgEl("line", { x1: px(5), y1: py(0), x2: px(5), y2: py(10), stroke: "#3f3f46", "stroke-width": 1, "stroke-dasharray": "3,3" }, svg);
  svgEl("line", { x1: px(0), y1: py(5), x2: px(10), y2: py(5), stroke: "#3f3f46", "stroke-width": 1, "stroke-dasharray": "3,3" }, svg);

  const labels = [
    [px(0), py(5) - 6, "é©æ–°"], [px(9.2), py(5) - 6, "ä¿å®ˆ"],
    [px(5) + 6, py(9.5), "å…¬å…±"], [px(5) + 6, py(0.5), "åˆ©å·±"]
  ];
  labels.forEach(([x, y, t]) => {
    svgEl("text", { x, y, "font-size": "8", fill: "#71717a" }, svg).textContent = t;
  });

  const a = analyze();
  if (a) {
    svgEl("line", { x1: px(a.cx) - 8, y1: py(a.cy), x2: px(a.cx) + 8, y2: py(a.cy), stroke: "#fbbf24", "stroke-width": 2 }, svg);
    svgEl("line", { x1: px(a.cx), y1: py(a.cy) - 8, x2: px(a.cx), y2: py(a.cy) + 8, stroke: "#fbbf24", "stroke-width": 2 }, svg);
  }

  members.forEach(m => {
    const r = 4 + m.z * 2;
    const c = dotColor(m.x, m.y);
    const isSel = m.id === selectedId;
    const g = svgEl("g", { style: "cursor:pointer" }, svg);

    svgEl("circle", {
      cx: px(m.x), cy: py(m.y), r,
      fill: c, "fill-opacity": isSel ? 0.5 : 0.25,
      stroke: c, "stroke-width": isSel ? 2.5 : 1
    }, g);

    g.addEventListener("click", () => { selectedId = selectedId === m.id ? null : m.id; render(); });
    g.addEventListener("mouseenter", () => showTooltip(g, m, r));
    g.addEventListener("mouseleave", () => { const tt = g.querySelector(".tt"); if (tt) tt.remove(); });

    if (isSel) showTooltip(g, m, r);
  });
}

function showTooltip(g, m, r) {
  if (g.querySelector(".tt")) return;
  const gg = svgEl("g", { class: "tt" }, g);
  const w = Math.max(m.name.length * 9, 80);
  svgEl("rect", { x: px(m.x) + r + 4, y: py(m.y) - 22, width: w, height: 36, rx: 4, fill: "#1e1e2e", stroke: "#3f3f46", "stroke-width": 1 }, gg);
  svgEl("text", { x: px(m.x) + r + 10, y: py(m.y) - 8, "font-size": "9", "font-weight": "600", fill: "#f4f4f5" }, gg).textContent = m.name;
  svgEl("text", { x: px(m.x) + r + 10, y: py(m.y) + 6, "font-size": "8", fill: "#a1a1aa" }, gg).textContent = `X:${m.x} Y:${m.y} Z:${m.z}`;
}

function renderTags() {
  const area = document.getElementById("tag-area");
  if (!members.length) { area.innerHTML = ""; return; }
  let html = `<p>ç™»éŒ²ï¼š${members.length}åï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼‰</p><div class="tag-list">`;
  members.forEach(m => {
    const c = dotColor(m.x, m.y);
    const bg = selectedId === m.id ? c + "33" : "#1e1e2e";
    html += `<span class="tag" data-id="${m.id}" style="background:${bg};border-color:${c}44;color:${c}">${m.name}</span>`;
  });
  html += "</div>";
  area.innerHTML = html;
  area.querySelectorAll(".tag").forEach(el => {
    el.addEventListener("click", () => { const id = +el.dataset.id; selectedId = selectedId === id ? null : id; render(); });
  });
}

function renderAnalysis() {
  const cont = document.getElementById("analysis-content");
  const a = analyze();
  if (!a) { cont.innerHTML = '<div class="panel empty-state">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã¨åˆ†æçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>'; return; }

  const hColor = a.health >= 60 ? "#10b981" : a.health >= 40 ? "#f59e0b" : "#ef4444";
  let html = '<div class="content-row">';

  html += `<div class="panel health-card">
    <p class="health-label">çµ„ç¹”å¥å…¨æ€§ã‚¹ã‚³ã‚¢</p>
    <div class="health-score" style="color:${hColor}">${a.health}</div>
    <p class="health-max">/ 100</p>`;
  if (a.critical) html += `<div class="warning-box">âš  è‡¨ç•Œç‚¹è­¦å‘Šï¼šã€Œä¿å®ˆÃ—åˆ©å·±ã€è±¡é™ã®æ¨©åŠ›æ¯”ç‡ãŒ50%ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚çµ„ç¹”ç¡¬ç›´åŒ–ã®ãƒªã‚¹ã‚¯ãŒé«˜ã„çŠ¶æ…‹ã§ã™ã€‚</div>`;
  html += `<div class="logic-section">
    <p class="logic-title">ç®—å‡ºãƒ­ã‚¸ãƒƒã‚¯</p>
    <p class="logic-body">æ¨©åŠ›åŠ é‡Yè»¸å¹³å‡ï¼ˆå…¬å…±æ€§ï¼‰Ã— 60% ï¼‹ å³ä¸‹è±¡é™ã®éæ¨©åŠ›æ¯”ç‡ Ã— 40%ã§ç®—å‡ºã€‚æ¨©åŠ›ã®å¤§ãã„äººã»ã©çµ„ç¹”å…¨ä½“ã®ã‚¹ã‚³ã‚¢ã¸ã®å½±éŸ¿ãŒå¤§ãããªã‚‹è¨­è¨ˆã€‚</p>
  </div></div>`;

  html += `<div class="panel dist-card"><p class="dist-title">è±¡é™åˆ¥ãƒ‘ãƒ¯ãƒ¼åˆ†å¸ƒï¼ˆæ¨©åŠ›Ã—äººæ•°ï¼‰</p>`;
  for (const [key, val] of Object.entries(QC)) {
    const pow = a.qPow[key] || 0;
    const ratio = a.totalZ ? pow / a.totalZ : 0;
    const cnt = a.quads[key].length;
    html += `<div class="bar-item">
      <div class="bar-header">
        <span class="bar-name" style="color:${val.border}">${val.label} <span class="count">(${cnt}å)</span></span>
        <span class="bar-value">æ¨©åŠ›å€¤ ${pow} (${Math.round(ratio * 100)}%)</span>
      </div>
      <div class="bar-track"><div class="bar-fill" style="width:${ratio * 100}%;background:${val.border}"></div></div>
    </div>`;
  }
  const xLabel = a.cx > 5 ? "ä¿å®ˆå¯„ã‚Š" : "é©æ–°å¯„ã‚Š";
  const yLabel = a.cy > 5 ? "å…¬å…±å¯„ã‚Š" : "åˆ©å·±å¯„ã‚Š";
  html += `<div class="center-box">
    <strong>çµ„ç¹”ã®é‡å¿ƒï¼š</strong>X=${a.cx.toFixed(1)}ï¼ˆ${xLabel}ï¼‰Y=${a.cy.toFixed(1)}ï¼ˆ${yLabel}ï¼‰<br>
    <span class="note">â€» æ¨©åŠ›å€¤ã§åŠ é‡å¹³å‡ã€‚æ¨©åŠ›ã®å¤§ãã„äººã»ã©çµ„ç¹”ã®æ–¹å‘æ€§ã«å½±éŸ¿ã€‚</span>
  </div></div>`;

  html += `<div class="panel reading-card panel-full">
    <p class="reading-title">åˆ†æã®èª­ã¿æ–¹</p>
    <div class="reading-body">
      <p>ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯ã€æ–°è¦‹æ™ºç´€æ°ã®ã€Œæ¨©åŠ›Ã—äººæ•°ã®é‡ã¿ä»˜ã‘ã€ä»®èª¬ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚å˜ç´”ã«ã€Œå³ä¸‹ï¼ˆä¿å®ˆÃ—åˆ©å·±ï¼‰ã®äººãŒä½•äººã„ã‚‹ã‹ã€ã§ã¯ãªãã€ãã®äººãŸã¡ãŒæŒã¤æ¨©åŠ›å€¤ã®åˆè¨ˆãŒçµ„ç¹”å…¨ä½“ã®ã©ã‚Œã ã‘ã‚’å ã‚ã‚‹ã‹ã§å¥å…¨æ€§ã‚’æ¸¬ã‚Šã¾ã™ã€‚</p>
      <p><span class="hl-gold">çµ„ç¹”ã®é‡å¿ƒï¼ˆé»„è‰²ã®åå­—ï¼‰</span>ãŒå³ä¸‹ã«æ²ˆã‚“ã§ã„ã‚‹ã»ã©ã€çµ„ç¹”å…¨ä½“ãŒã€Œæ¨©åŠ›è€…ã®ä¿èº«ã€ã«ã‚ˆã£ã¦æ–¹å‘ã¥ã‘ã‚‰ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚</p>
      <p><span class="hl-red">è‡¨ç•Œç‚¹</span>ï¼šå³ä¸‹è±¡é™ã®æ¨©åŠ›æ¯”ç‡ãŒ50%ã‚’è¶…ãˆã‚‹ã¨ã€é©æ–°çš„ãƒ»å…¬å…±çš„ãªäººæãŒé›¢è„±ã—å§‹ã‚ã€ãƒãƒ©ãƒ³ã‚¹ãŒã•ã‚‰ã«å´©ã‚Œã‚‹è‡ªå·±å¼·åŒ–ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚</p>
    </div>
  </div>`;

  html += "</div>";
  cont.innerHTML = html;
}

function renderMembers() {
  const cont = document.getElementById("members-content");
  if (!members.length) { cont.innerHTML = '<div class="empty-state">ãƒ¡ãƒ³ãƒãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åº§æ¨™ãƒãƒƒãƒ—ã‚¿ãƒ–ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>'; return; }
  const a = analyze();
  let html = "<table><thead><tr><th>åå‰</th><th>Xï¼ˆä¿å®ˆæ€§ï¼‰</th><th>Yï¼ˆå…¬å…±æ€§ï¼‰</th><th>Zï¼ˆæ¨©åŠ›ï¼‰</th><th>è±¡é™</th><th>æ¨©åŠ›å½±éŸ¿åº¦</th><th></th></tr></thead><tbody>";
  members.forEach(m => {
    const q = getQ(m.x, m.y);
    const inf = a ? ((m.z / a.totalZ) * 100).toFixed(1) : "0";
    html += `<tr>
      <td class="name-cell">${m.name}</td><td>${m.x}</td><td>${m.y}</td><td>${m.z}</td>
      <td><span class="q-badge" style="background:${QC[q].border}22;color:${QC[q].border}">${QC[q].label}</span></td>
      <td style="color:#a1a1aa">${inf}%</td>
      <td><button class="remove-btn" data-id="${m.id}">âœ•</button></td>
    </tr>`;
  });
  html += "</tbody></table>";
  cont.innerHTML = html;
  cont.querySelectorAll(".remove-btn").forEach(el => {
    el.addEventListener("click", () => { const id = +el.dataset.id; members = members.filter(m => m.id !== id); if (selectedId === id) selectedId = null; render(); });
  });
}

function render() {
  renderPlot();
  renderTags();
  renderAnalysis();
  renderMembers();
}

// --- Excel import ---
function importExcel(file) {
  const resultEl = document.getElementById("import-result");
  const reader = new FileReader();

  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });

      // Use first sheet
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      if (rows.length < 2) {
        resultEl.className = "import-result error";
        resultEl.textContent = "ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚2è¡Œç›®ä»¥é™ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      const imported = [];
      let skipped = 0;

      // Skip header row (row 0), parse from row 1
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || !row[0]) continue;

        const name = String(row[0]).trim();
        const x = parseFloat(row[1]);
        const y = parseFloat(row[2]);
        const z = parseFloat(row[3]);

        if (!name || isNaN(x) || isNaN(y) || isNaN(z)) {
          skipped++;
          continue;
        }

        imported.push({
          id: nextId++,
          name,
          x: clamp(Math.round(x), 0, 10),
          y: clamp(Math.round(y), 0, 10),
          z: clamp(Math.round(z), 1, 10),
        });
      }

      if (imported.length === 0) {
        resultEl.className = "import-result error";
        resultEl.textContent = "æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ—ã®é †ç•ªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      members = imported;
      selectedId = null;
      render();

      let msg = `${imported.length}åã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`;
      if (skipped > 0) msg += ` ï¼ˆ${skipped}è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰`;
      resultEl.className = "import-result success";
      resultEl.textContent = msg;

    } catch (err) {
      resultEl.className = "import-result error";
      resultEl.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message;
    }
  };

  reader.readAsArrayBuffer(file);
}

// --- Excel export ---
function exportExcel() {
  if (!members.length) { alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }

  const wsData = [["åå‰", "Xï¼ˆä¿å®ˆæ€§ï¼š0-10ï¼‰", "Yï¼ˆå…¬å…±æ€§ï¼š0-10ï¼‰", "Zï¼ˆæ¨©åŠ›ï¼š1-10ï¼‰"]];
  members.forEach(m => wsData.push([m.name, m.x, m.y, m.z]));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);

  ws["!cols"] = [{ wch: 20 }, { wch: 18 }, { wch: 18 }, { wch: 18 }];

  XLSX.utils.book_append_sheet(wb, ws, "çµ„ç¹”åº§æ¨™ãƒ‡ãƒ¼ã‚¿");
  XLSX.writeFile(wb, "org-coordinate-data.xlsx");
}

// --- Template download ---
function downloadTemplate() {
  const wsData = [
    ["åå‰", "Xï¼ˆä¿å®ˆæ€§ï¼š0-10ï¼‰", "Yï¼ˆå…¬å…±æ€§ï¼š0-10ï¼‰", "Zï¼ˆæ¨©åŠ›ï¼š1-10ï¼‰"],
    ["ï¼ˆã“ã“ã«åå‰ã‚’å…¥åŠ›ï¼‰", 5, 5, 5],
  ];

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws["!cols"] = [{ wch: 20 }, { wch: 18 }, { wch: 18 }, { wch: 18 }];
  XLSX.utils.book_append_sheet(wb, ws, "çµ„ç¹”åº§æ¨™ãƒ‡ãƒ¼ã‚¿");
  XLSX.writeFile(wb, "org-coordinate-template.xlsx");
}

// --- Event listeners ---

// Tabs
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
  });
});

// Sliders
["x", "y", "z"].forEach(k => {
  document.getElementById("input-" + k).addEventListener("input", e => {
    document.getElementById("val-" + k).textContent = e.target.value;
  });
});

// Add member
document.getElementById("btn-add").addEventListener("click", () => {
  const name = document.getElementById("input-name").value.trim();
  if (!name) return;
  members.push({
    id: nextId++,
    name,
    x: +document.getElementById("input-x").value,
    y: +document.getElementById("input-y").value,
    z: +document.getElementById("input-z").value
  });
  document.getElementById("input-name").value = "";
  document.getElementById("input-x").value = 5; document.getElementById("val-x").textContent = "5";
  document.getElementById("input-y").value = 5; document.getElementById("val-y").textContent = "5";
  document.getElementById("input-z").value = 5; document.getElementById("val-z").textContent = "5";
  render();
});

// Sample & Clear
document.getElementById("btn-sample").addEventListener("click", () => {
  members = SAMPLE.map(m => ({ ...m }));
  nextId = 7;
  selectedId = null;
  document.getElementById("import-result").className = "import-result";
  render();
});

document.getElementById("btn-clear").addEventListener("click", () => {
  members = [];
  selectedId = null;
  document.getElementById("import-result").className = "import-result";
  render();
});

// Excel buttons
document.getElementById("btn-import").addEventListener("click", () => {
  document.getElementById("file-input").click();
});

document.getElementById("file-input").addEventListener("change", (e) => {
  if (e.target.files.length > 0) {
    importExcel(e.target.files[0]);
    e.target.value = "";
  }
});

document.getElementById("btn-export").addEventListener("click", exportExcel);
document.getElementById("btn-template").addEventListener("click", downloadTemplate);

// Enter key
document.getElementById("input-name").addEventListener("keydown", e => {
  if (e.key === "Enter") document.getElementById("btn-add").click();
});

render();
</script>
</body>
</html>
